{% extends "base.html" %}

{% block title %}
Cadastro de Pacientes ~ Hackathon
{% endblock %}

{% block header %}
Cadastro de Pacientes
{% endblock %}

{% block content %}
<form id="paciente_form" class="flex flex-col max-w-sm mx-auto p-6 bg-white rounded-lg shadow-lg">
    <div class="flex flex-col mb-4">
        <label for="documento" class="text-zinc-800 font-semibold mb-2">Documento:</label>
        <input type="text" name="documento"
            class="px-4 py-2 rounded-lg border border-zinc-300 bg-zinc-100 text-zinc-800 placeholder-zinc-400 focus:outline-none focus:ring-2 focus:ring-green-400 focus:border-green-400 transition duration-200 ease-in-out">
    </div>
    <div class="flex flex-col mb-4">
        <label for="nome" class="text-zinc-800 font-semibold mb-2">Nome:</label>
        <input type="text" name="nome"
            class="px-4 py-2 rounded-lg border border-zinc-300 bg-zinc-100 text-zinc-800 placeholder-zinc-400 focus:outline-none focus:ring-2 focus:ring-green-400 focus:border-green-400 transition duration-200 ease-in-out">
    </div>
    <div class="flex flex-col mb-6">
        <label for="data_nascimento" class="text-zinc-800 font-semibold mb-2">Data de Nascimento:</label>
        <input type="date" name="data_nascimento" id="data_nascimento"
            class="px-4 py-2 rounded-lg border border-zinc-300 bg-zinc-100 text-zinc-800 placeholder-zinc-400 focus:outline-none focus:ring-2 focus:ring-green-400 focus:border-green-400 transition duration-200 ease-in-out">
    </div>
    <button type="submit"
        class="text-zinc-800 bg-green-500 border border-green-600 hover:bg-green-700 hover:border-green-400 focus:bg-green-800 focus:border-green-500 hover:text-white focus:text-white font-semibold py-3 px-6 rounded-lg w-full transition-all duration-200 ease-in-out shadow-md hover:shadow-lg focus:shadow-lg focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
        Enviar
    </button>
</form>

<script>
    const form = document.getElementById('paciente_form');

    form.addEventListener('submit', async (event) => {
        try {
            event.preventDefault();

            const formObject = getFormData(form);

            const exists = await checkIfExists(formObject.documento);

            if (!exists) {
                const paciente = await createPaciente();
                window.location.href = `/pacientes/${paciente.id}`;

            }

        } catch (error) {
            console.log(error);
        }
    });

    const getFormData = (form) => {
        const data = new FormData(form);

        const formObject = Object.fromEntries(
            [...data].map(([key, value]) => [key, value])
        );

        return formObject;
    };

    const checkIfExists = async (documento) => {
        const response = await fetch(`/api/v1/pacientes/${documento}`);

        return response.status == 404 ? false : true;
    };

    const createPaciente = async (formObject) => {
        const jsonData = JSON.stringify(formObject);

        const response = await fetch('/api/v1/pacientes/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: jsonData,
        });

        if (response.status != 201) throw new Error('NÃ£o foi possivel registrar o paciente');

        const data = await response.json();

        const paciente = JSON.parse(data);

        return paciente;
    };
</script>
{% endblock %}